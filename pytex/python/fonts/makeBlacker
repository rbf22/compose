#!/usr/bin/env python3

"""Python port of makeBlacker - Creates the metafont file needed for darker copies of the TeX fonts."""

import sys
import os
import re

def edit_mftrace(mftrace_path, old_mftrace_path):
    """Edit mftrace to use the blacker metafont file."""
    print("Editing mftrace")

    with open(old_mftrace_path, 'r') as f:
        mftrace_content = f.read()

    # Replace the mf command to use our blacker.mf file
    mftrace_content = re.sub(
        r'r"mf \\mode:=\([^;]*\); ([^"]*)"',
        r'r"""mf \\smode:="lib/blacker.mf"\1"""',
        mftrace_content
    )

    with open(mftrace_path, 'w') as f:
        f.write(mftrace_content)

    # Make it executable
    os.chmod(mftrace_path, 0o755)

def make_blacker_mf(blacker_value):
    """Create the blacker.mf metafont file."""
    print(f"Using blacker = {blacker_value}")

    with open("lib/blacker.mf", 'w') as f:
        f.write(f"""proofing:=0;
fontmaking:=1;
tracingtitles:=0;
pixels_per_inch:=1200;
blacker:={blacker_value};
fillin:=0;
o_correction:=1;
""")

def main():
    if len(sys.argv) < 2:
        print("Usage: ./makeBlacker <blackness>", file=sys.stderr)
        sys.exit(1)

    blacker = sys.argv[1]
    if not blacker:
        print("Usage: ./makeBlacker <blackness>", file=sys.stderr)
        sys.exit(1)

    try:
        blacker_value = float(blacker)
    except ValueError:
        print("Error: blackness must be a number", file=sys.stderr)
        sys.exit(1)

    # Load configuration
    config_file = "custom.cfg.pl"
    config = {}

    if os.path.exists(config_file):
        with open(config_file, 'r') as f:
            for line in f:
                line = line.strip()
                if '=' in line:
                    key, value = line.split('=', 1)
                    key = key.strip()
                    value = value.strip().strip("';")
                    config[key] = value

    mftrace_path = config.get('MFTRACE_PATH', 'mftrace')
    old_mftrace = mftrace_path
    new_mftrace = "./lib/mftrace-modified"

    edit_mftrace(new_mftrace, old_mftrace)
    make_blacker_mf(blacker_value)

if __name__ == "__main__":
    main()
